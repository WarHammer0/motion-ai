  ## services
  - platform: rest
    name: hznmonitor_service_list
    resource: !secret hznmonitor-services
    method: GET
    authentication: basic
    force_update: true
    json_attributes:
      - services
    value_template: >
      {%- if value_json is defined -%}
        {{ value_json.services|length }}
      {%- else -%}null{%- endif -%}
  - platform: template
    sensors:
      hznmonitor_services_count:
        entity_id:
          - sensor.hznmonitor_service_list
        unit_of_measurement: count
        value_template: >
          {%- if states.sensor.hznmonitor_service_list.attributes.services|length > 0 %}
           {{ states.sensor.hznmonitor_service_list.attributes.services|length }}
          {% else %}null{% endif %}
  ## statistics
  - platform: history_stats
    name: hznmonitor_services_count_history
    entity_id: sensor.hznmonitor_services_count
    state: 'true'
    type: count
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'
  - platform: statistics
    name: hznmonitor_services_count_statistics
    entity_id: sensor.hznmonitor_services_count
    sampling_size: 100
    max_age:
      hours: 48
  ## nodes
  - platform: rest
    name: hznmonitor_node_list
    resource: !secret hznmonitor-nodes
    method: GET
    authentication: basic
    force_update: true
    json_attributes:
      - nodes
    value_template: >
      {%- if value_json is defined -%}
        {{ value_json.nodes|length }}
      {%- else -%}null{%- endif -%}
  - platform: template
    sensors:
      hznmonitor_nodes_count:
        entity_id:
          - sensor.hznmonitor_node_list
        unit_of_measurement: count
        value_template: >
          {%- if states.sensor.hznmonitor_node_list is defined 
            and states.sensor.hznmonitor_node_list.attributes is defined
            and states.sensor.hznmonitor_node_list.attributes.nodes is defined %}
              {{ states.sensor.hznmonitor_node_list.attributes.nodes|length }}
          {% else %}null{% endif %}
  ## statistics
  - platform: history_stats
    name: hznmonitor_nodes_count_history
    entity_id: sensor.hznmonitor_nodes_count
    state: 'true'
    type: count
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'
  - platform: statistics
    name: hznmonitor_nodes_count_statistics
    entity_id: sensor.hznmonitor_nodes_count
    sampling_size: 100
    max_age:
      hours: 48
  ## patterns
  - platform: rest
    name: hznmonitor_pattern_list
    resource: !secret hznmonitor-patterns
    method: GET
    authentication: basic
    force_update: true
    json_attributes:
      - patterns
      - exchange
      - org
    value_template: >
      {%- if value_json is defined -%}
        {{ value_json.patterns|length }}
      {%- else -%}null{%- endif -%}
  - platform: template
    sensors:
      hznmonitor_patterns_count:
        entity_id:
          - sensor.hznmonitor_pattern_list
        unit_of_measurement: count
        value_template: >
          {%- if states.sensor.hznmonitor_pattern_list.attributes.patterns|length > 0 %}
           {{ states.sensor.hznmonitor_pattern_list.attributes.patterns|length }}
          {% else %}null{% endif %}
      hznmonitor_patterns_exchange:
        entity_id:
          - sensor.hznmonitor_pattern_list
        value_template: >
          {%- if states.sensor.hznmonitor_pattern_list.attributes.exchange is defined %}
           {{ states.sensor.hznmonitor_pattern_list.attributes.exchange }}
          {% else %}null{% endif %}
      hznmonitor_patterns_org:
        entity_id:
          - sensor.hznmonitor_pattern_list
        value_template: >
          {%- if states.sensor.hznmonitor_pattern_list.attributes.org is defined %}
           {{ states.sensor.hznmonitor_pattern_list.attributes.org }}
          {% else %}null{% endif %}
      hznmonitor_patterns_id:
        entity_id:
          - sensor.hznmonitor_pattern_list
        value_template: >
          {%- if states.sensor.hznmonitor_pattern_list.attributes.patterns|length > 0 %}
            {%- for pattern in states.sensor.hznmonitor_pattern_list.attributes.patterns -%}
              {% if loop.first %}[{% else %},{% endif %}
              {{- pattern.id|replace(states.sensor.hznmonitor_patterns_org.state+"/","")|tojson -}}
              {%- if loop.last -%}]{%- endif -%}
            {% endfor %}
          {% else %}null{% endif %}
  ## statistics
  - platform: history_stats
    name: hznmonitor_patterns_count_history
    entity_id: sensor.hznmonitor_patterns_count
    state: 'true'
    type: count
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'
  - platform: statistics
    name: hznmonitor_patterns_count_statistics
    entity_id: sensor.hznmonitor_patterns_count
    sampling_size: 100
    max_age:
      hours: 48
  ## exchange
  - platform: rest
    name: hznmonitor_exchange_status
    resource: !secret hznmonitor-exchange
    method: GET
    authentication: basic
    force_update: true
    json_attributes:
      - msg
      - org
      - user
      - url
      - numberOfUsers
      - numberOfNodes
      - numberOfNodeAgreements
      - numberOfNodeMsgs
      - numberOfAgbots
      - numberOfAgbotAgreements
      - numberOfAgbotMsgs
      - dbSchemaVersion
    value_template: >
      {%- if value_json is defined -%} {{ value_json.msg }} {%- else -%}null{%- endif -%}
  - platform: template
    sensors:
      hznmonitor_exchange_org:
        entity_id:
          - sensor.hznmonitor_exchange_status
        value_template: >
          {% if states.sensor.hznmonitor_exchange_status is defined %}
            {{ states.sensor.hznmonitor_exchange_status.attributes.org }}
          {% else %}null{% endif %}
      hznmonitor_exchange_url:
        entity_id:
          - sensor.hznmonitor_exchange_status
        value_template: >
          {% if states.sensor.hznmonitor_exchange_status is defined %}
            {{ states.sensor.hznmonitor_exchange_status.attributes.url }}
          {% else %}null{% endif %}
      hznmonitor_exchange_msg:
        entity_id:
          - sensor.hznmonitor_exchange_status
        value_template: >
          {% if states.sensor.hznmonitor_exchange_status is defined %}
            {{ states.sensor.hznmonitor_exchange_status.attributes.msg }}
          {% else %}null{% endif %}
      hznmonitor_exchange_agbot_agreements:
        unit_of_measurement: count
        entity_id:
          - sensor.hznmonitor_exchange_status
        value_template: >
          {% if states.sensor.hznmonitor_exchange_status is defined %}
            {{ states.sensor.hznmonitor_exchange_status.attributes.numberOfAgbotAgreements|int }}
          {% else %}null{% endif %}
      hznmonitor_exchange_node_agreements:
        unit_of_measurement: count
        entity_id:
          - sensor.hznmonitor_exchange_status
        value_template: >
          {% if states.sensor.hznmonitor_exchange_status is defined %}
            {{ states.sensor.hznmonitor_exchange_status.attributes.numberOfNodeAgreements|int }}
          {% else %}null{% endif %}
      hznmonitor_exchange_agbot_msgs:
        unit_of_measurement: count
        entity_id:
          - sensor.hznmonitor_exchange_status
        value_template: >
          {% if states.sensor.hznmonitor_exchange_status is defined %}
            {{ states.sensor.hznmonitor_exchange_status.attributes.numberOfAgbotAgreements|int }}
          {% else %}null{% endif %}
      hznmonitor_exchange_node_msgs:
        unit_of_measurement: count
        entity_id:
          - sensor.hznmonitor_exchange_status
        value_template: >
          {% if states.sensor.hznmonitor_exchange_status is defined %}
            {{ states.sensor.hznmonitor_exchange_status.attributes.numberOfNodeAgreements|int }}
          {% else %}null{% endif %}
      hznmonitor_exchange_nodes:
        unit_of_measurement: count
        entity_id:
          - sensor.hznmonitor_exchange_status
        value_template: >
          {% if states.sensor.hznmonitor_exchange_status is defined %}
            {{ states.sensor.hznmonitor_exchange_status.attributes.numberOfNodes|int }}
          {% else %}null{% endif %}
      hznmonitor_exchange_users:
        unit_of_measurement: count
        entity_id:
          - sensor.hznmonitor_exchange_status
        value_template: >
          {% if states.sensor.hznmonitor_exchange_status is defined %}
            {{ states.sensor.hznmonitor_exchange_status.attributes.numberOfUsers|int }}
          {% else %}null{% endif %}
      hznmonitor_exchange_schema_version:
        unit_of_measurement: version
        entity_id:
          - sensor.hznmonitor_exchange_dbSchemaVersion
        value_template: >
          {% if states.sensor.hznmonitor_exchange_status is defined %}
            {{ states.sensor.hznmonitor_exchange_status.attributes.dbSchemaVersion }}
          {% else %}null{% endif %}
  ## statistics
  - platform: history_stats
    name: hznmonitor_exchange_agbot_agreements_history
    entity_id: sensor.hznmonitor_exchange_agbot_agreements
    state: 'true'
    type: count
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'
  - platform: statistics
    name: hznmonitor_exchange_agbot_agreements_statistics
    entity_id: sensor.hznmonitor_exchange_agbot_agreements
    sampling_size: 100
    max_age:
      hours: 48
  - platform: history_stats
    name: hznmonitor_exchange_node_agreements_history
    entity_id: sensor.hznmonitor_exchange_node_agreements
    state: 'true'
    type: count
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'
  - platform: statistics
    name: hznmonitor_exchange_node_agreements_statistics
    entity_id: sensor.hznmonitor_exchange_node_agreements
    sampling_size: 100
    max_age:
      hours: 48
  - platform: history_stats
    name: hznmonitor_exchange_agbot_msgs_history
    entity_id: sensor.hznmonitor_exchange_agbot_msgs
    state: 'true'
    type: count
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'
  - platform: statistics
    name: hznmonitor_exchange_agbot_msgs_statistics
    entity_id: sensor.hznmonitor_exchange_agbot_msgs
    sampling_size: 100
    max_age:
      hours: 48
  - platform: history_stats
    name: hznmonitor_exchange_node_msgs_history
    entity_id: sensor.hznmonitor_exchange_node_msgs
    state: 'true'
    type: count
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'
  - platform: statistics
    name: hznmonitor_exchange_node_msgs_statistics
    entity_id: sensor.hznmonitor_exchange_node_msgs
    sampling_size: 100
    max_age:
      hours: 48
  - platform: history_stats
    name: hznmonitor_exchange_nodes_history
    entity_id: sensor.hznmonitor_exchange_nodes
    state: 'true'
    type: count
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'
  - platform: statistics
    name: hznmonitor_exchange_nodes_statistics
    entity_id: sensor.hznmonitor_exchange_nodes
    sampling_size: 100
    max_age:
      hours: 48
  - platform: history_stats
    name: hznmonitor_exchange_users_history
    entity_id: sensor.hznmonitor_exchange_users
    state: 'true'
    type: count
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'
  - platform: statistics
    name: hznmonitor_exchange_users_statistics
    entity_id: sensor.hznmonitor_exchange_users
    sampling_size: 100
    max_age:
      hours: 48
