###
# homeassistant/automation/motion/smartphone.yaml
###

- id: motion_device_tracker
  alias: motion_device_tracker
  initial_state: on
  trigger:
    - platform: state
      entity_id: sensor.motion_device_tracker_count
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >
          {% set e = states('sensor.motion_device_tracker_count') %}
          {{ e is not none and e|lower != 'unavailable' and e|lower != 'unknown' and e|lower != 'none' and e|lower != 'null' }}
      - condition: template
        value_template: >-
          {% set e = state_attr('input_select.motion_smartphone_selected','options') %}
          {{ e is not none and e|lower != 'unavailable' and e|lower != 'unknown' and e|lower != 'none' and e|lower != 'null' }}
  action:
    - service: python_script.input_select_set_options
      data_template:
        entity_id: input_select.motion_smartphone_selected
        default: all
        options: >-
          {%- for state in states.device_tracker -%}
            {%- set d = state.entity_id|replace('device_tracker.','') -%}
            {%- set e = 'sensor.' + d -%}
            {%- for s in states.sensor if d in s.entity_id and e+'_activity' in s.entity_id and (utcnow().timestamp() - as_timestamp(s.last_updated))|int < 86400 -%}
              "{{- s.entity_id|replace('sensor.','')|replace('_activity','') -}}",
              {%- endfor -%}
          {%- endfor -%}"all"
